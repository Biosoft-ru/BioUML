#####################################################################################
#####################################CONSTANTS########################################
#######################################################################################
#set ($BR = "
")
#set ($INDENT = "  ")
#set ($QUOTE = '"')
#######################################################################################
#####################################MACROS############################################
#######################################################################################
#macro(comma $list)
#if($velocityCount < $list.size()),#end
#end
#######################################################################################
#macro(callNF $call)
#set ($inputs = $helper.getInputs($call))
#if ($inputs.size()> 0)
  $helper.getResultName($call) = $helper.getTaskRef($call)(#foreach($input in $inputs)$helper.getInputName($helper.getSource($input))#comma($inputs)#end)
#else
  $helper.getResultName($call) = $helper.getTaskRef($call)()
#end
#end
#######################################################################################
#macro(scatterNF $scatter)
#set ($scatterVar = $helper.getCycleVariable($scatter))
#set ($scatterName = $helper.getCycleName($scatter))
  Channel.from($scatterName).set { $scatterVar }
#foreach( $call in $helper.getCalls($scatter))#callNF($call)#end
#end
#######################################################################################
#set ($externalParameters = $helper.getExternalParameters())
#if ($externalParameters.size() > 0)
#foreach( $externalParameter in $externalParameters )
$helper.getExternalInput($externalParameter)
#end
#end
#if($externalParameters.size() > 0)$BR#end
#######################################################################################
#######################################TASKS###########################################
#######################################################################################
#foreach( $task in $helper.getTasks())
process $task.getName() {
#set ($inputs = $helper.getInputs($task))
#if ($inputs.size() > 0)
$BR  input :
#foreach( $input in $inputs )
  $helper.getDeclaration($input)
#end
#end
$BR  publishDir "$task.getName()", mode: 'copy'
$BR  script:
  """
  $helper.getCommand($task).trim()
  """
#set ($outputs = $helper.getOutputs($task))
#if ($outputs.size() > 0)
$BR  output:
#foreach( $output in $outputs )
  $helper.getType($output) $helper.getExpression($output), emit: $helper.getName($output) 
#end
#end
}$BR
#end
#######################################################################################
###################################WORKFLOW############################################
#######################################################################################
workflow {
  main:
#foreach( $call in $helper.getCalls($diagram))#callNF($call)#end
#foreach( $scatter in $helper.getScatters($diagram))#scatterNF($scatter)#end
}